<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Silva-Redux-Todo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
    <script src='https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/babel-standalone@6.15.0/babel.min.js'></script>
    <script src='https://tylermcginnis.com/goals-todos-api/index.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux-thunk/2.2.0/redux-thunk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/5.0.7/react-redux.min.js"></script>
</head>
<body>

    <div id="root"></div>

<script>
    /*-----------------------------  REACT CODE  ------------------------------------------------------*/

    function generateId () {
        return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
    }
    /// API for user

    const [ADD_TODO, REMOVE_TODO, TOGGLE_TODO] = ['ADD_TODO', 'REMOVE_TODO', 'TOGGLE_TODO'];
    const [ADD_GOAL, REMOVE_GOAL] = ['ADD_GOAL', 'REMOVE_GOAL'];
    const RECEIVE_DATA = 'RECEIVE_DATA';

    const TODO = {
        add: (todo) => {
            return {
                type: ADD_TODO,
                todo: {
                    id: todo.id,
                    name: todo.name,
                    complete: todo.complete,
                }
            }
        },
        remove: (id) => {
            return {
                type: REMOVE_TODO,
                id
            }
        },
        toggle: (id) => {
            return {
                type: TOGGLE_TODO,
                id
            }
        }
    };
    const GOAL = {
        add: (goal) => {
            return {
                type: ADD_GOAL,
                goal: {
                    id: goal.id,
                    name: goal.name
                }
            }
        },
        remove: (id) => {
            return {
                type: REMOVE_GOAL,
                id
            }
        }
    };
    function receiveDataAction(todos, goals) {
        return {
            type: RECEIVE_DATA,
            todos,
            goals
        }
    }
    function handleRemoveTodo(todo) {
        return (dispatch) => {
            dispatch(
                TODO.remove(todo.id)
            );
            return API.deleteTodo(todo.id).catch( err => {
                dispatch(
                    TODO.add(todo)
                );
                alert('Opps, there were some errors');
            });
        }
    }

    function handleAddTodo() {
        return (dispatch) => {
            return API.saveTodo(this.input.value).then(todo => {
                this.input.value = '';
                dispatch(
                    TODO.add(todo)
                );
            }).catch(() => {
                alert('Opps, there werer some errs, try again please');
            })
        }
    }
    function handleToggleTodo({id}) {
        return (dispatch) => {
            dispatch(
                TODO.toggle(id)
            );
            API.saveTodoToggle(id).catch( err => {
                dispatch(
                    TODO.toggle(id)
                );
                alert('Opps, try again please');
            });
        }
    }
    function handleReceiveData() {
        return (dispatch) => {
            return Promise.all([
                API.fetchTodos(),
                API.fetchGoals()
            ]).then(([todos, goals]) => {
                dispatch(
                    receiveDataAction(todos, goals)
                );
            }).catch(err => {
                console.log(err);
            });
        }
    }

    function handleRemoveGoal(goal) {
        return (dispatch) => {
            dispatch(
                GOAL.remove(goal.id)
            );

            API.deleteGoal(goal.id).catch( err => {
                dispatch(GOAL.add(goal));
                alert('Opps, there were some errros');
            });
        }
    }
    function handleAddGoal() {
        let goal = this.input.value;
        return (dispatch) => {
            return API.saveGoal(goal).then(newGoal => {
                this.input.value = '';
                dispatch(
                    GOAL.add(newGoal)
                );
            }).catch(() => {
                alert('Opps, there were some errs, try again please');
            });
        }

    }
    const checker = (store) => (next) => (action) => {
        // check if contain the text bitcoin then alert and return nothing;
        if (action.type === ADD_TODO && action.todo.name.toLowerCase().indexOf('bitcoin') !== -1) {
            return alert('no Bitcoint here');
        }
        if (action.type === ADD_GOAL && action.goal.name.toLowerCase().indexOf('bitcoin') !== -1) {
            return alert('no Bitcoint here');
        }
        return next(action);
    };

    const logger = (store) => (next) => (action) => {
        console.group(action.type);
        console.log('Current Action is: ', action);
        next(action);
        console.log('The new State is: ', store.getState());
        console.groupEnd();
    };
    
    function loading(state = true, action) {
        switch (action.type) {
            case RECEIVE_DATA:
                return false;
            default:
                return state;
        }
    }

//    const thunk  = (store) => (next) => (action) => {
//        if (typeof action !== "function") {
//            return next(action);
//        }
//
//        return action(store.dispatch);
//    };

    function todos (currentState = [], action) {
        switch (action.type) {
            case ADD_TODO:
                return currentState.concat([action.todo]);
            case REMOVE_TODO:
                return currentState.filter(todo => todo.id !== action.id);
            case TOGGLE_TODO:
                return currentState.map(todo => {
                    if (todo.id === action.id) {
                        return Object.assign({}, todo, {complete: !todo.complete});
                    }
                    return todo;
                });
            case RECEIVE_DATA:
                return action.todos;
            default:
                return currentState;
        }

    }
    function goals (currentState = [], action) {
        switch (action.type) {
            case ADD_GOAL:
                return currentState.concat([action.goal]);
            case REMOVE_GOAL:
                return currentState.filter(goal => goal.id !== action.id);
            case RECEIVE_DATA:
                return action.goals;
            default:
                return currentState;
        }
    }

    function app(state = {}, action) {

        return {
            todos: todos(state.todos, action),
            goals: goals(state.goals, action),
            loading: loading(state.loading, action)
        }
    }

    const store = Redux.createStore(app, Redux.applyMiddleware(ReduxThunk.default, checker, logger));



</script>

<script type="text/babel">
    class Loading extends React.Component {
        state = {
            label: this.props.label
        }

        componentDidMount () {
            const { label, intervalTime } = this.props;
            let stopper = label + '...';

            this.interval = setInterval(() => {
                this.state.label === stopper
                    ? this.setState(() => ({label}))
                    : this.setState( prevState  => ({label: prevState.label + '.'}) )
            }, intervalTime);
        }

        componentWillUnmount () {
            clearInterval(this.interval);
        }

        render () {
            return (
                    <p className='loading-label' style={this.props.style}>{this.state.label}</p>
            )
        }
    }

    function ListItem(props) {
        let item = props.item;
        return (
            <li>
                {props.children}
                <button onClick={props.onClick.bind(null, item)}>X</button>
            </li>
        );
    }

    class Todos extends React.Component {
        addTodo (event) {
            event.preventDefault();
            this.props.dispatch(
                handleAddTodo.call(this)
            );

        }

        removeTodo (todo) {
            this.props.dispatch(
                handleRemoveTodo(todo)
            );
        }

        toggleTodo = (todo) => {
            this.props.dispatch(
                handleToggleTodo(todo)
            );
        }
        render () {
            return (
                <div>
                    <h1>Todo List ?></h1>
                    <input type="text" placeholder="Add Todo" ref={(input) => this.input = input}/>
                    <button onClick={(event) => this.addTodo(event)}>Add Todo</button>
                    <ul className="todos">
                        {this.props.todos.map( (todo, index) => {
                            return (
                                    <ListItem onClick={(todo) => this.removeTodo(todo)} key={index} item={todo}>
                                        <span onClick={this.toggleTodo.bind(null, todo)} style={{"textDecoration": todo.complete ? "line-through" : 'none'}}>{todo.name}</span>
                                    </ListItem>
                            );
                        })}
                    </ul>
                </div>
            )
        }

    }
    class Goals extends React.Component {

        addGoal = (event) => {
            event.preventDefault();
            this.props.dispatch(
                handleAddGoal.call(this)
            )

        }
        removeGoal = (goal) => {
            this.props.dispatch(
                handleRemoveGoal(goal)
            )
        }
        render () {
            return (
                 <div>
                    <h1>Goals ?></h1>
                    <input type="text" placeholder="Add Goal" ref={(input) => this.input = input}/>
                    <button onClick={this.addGoal}>Add Goal</button>
                    <ul className="goals">
                        {this.props.goals.map( (goal, index) => {
                            return (
                                    <ListItem onClick={this.removeGoal} key={index} item={goal}>
                                        <span>{goal.name}</span>
                                    </ListItem>
                            );
                        })}
                    </ul>
                </div>
            )
        }
    }

//    const Context = React.createContext();
//
//    class Provider extends React.Component {
//        render () {
//            return (
//                <div>
//                    <Context.Provider value={this.props.store}>
//                        {this.props.children}
//                    </Context.Provider>
//                </div>
//            )
//        }
//    }

    class App extends React.Component {
        componentDidMount () {
            this.props.dispatch(
                handleReceiveData()
            );

//            this.props.store.subscribe(() => this.forceUpdate()); // we'll move this function to the connect itself
        }
        render () {
            if (this.props.loading) {
                return <Loading label="Loading" intervalTime="200"/>
            }

            return (
                <div>
                    <ConnectedTodos/>
                    <ConnectedGoals/>
                </div>
            )
        }
    }
//    function connect(stateDes) {
//        return (Component) => {
//            class Receiver extends React.Component {
//                componentDidMount () {
//                    const { subscribe } = this.props.store;
//                    this.unsub = subscribe(() => this.forceUpdate());
//                }
//                componentWillUnMount () {
//                    this.unsub();
//                }
//                render () {
//                    let {dispatch} = this.props.store;
//                    let appState = this.props.store.getState();
//                    let neededState = stateDes(appState);
//
//                    return <Component dispatch={dispatch} {...neededState}/>;
//                }
//
//            }
//            class ConnectedComponent extends React.Component {
//                render () {
//                    return (
//                            <Context.Consumer>
//                                {(store) => {
//                                    return <Receiver store={store} />;
//                                }}
//                            </Context.Consumer>
//                    )
//                }
//            }
//            return ConnectedComponent;
//        }
//    }
    const ConnectedApp = ReactRedux.connect((state) => ({
        loading: state.loading
    }))(App);
    const ConnectedTodos = ReactRedux.connect((state) => ({
        todos: state.todos
    }))(Todos);

    const ConnectedGoals = ReactRedux.connect((state) => ({
        goals: state.goals
    }))(Goals);

    ReactDOM.render(
        <ReactRedux.Provider store={store}>
            <ConnectedApp />
        </ReactRedux.Provider>, document.getElementById('root'));
</script>
</body>
</html>